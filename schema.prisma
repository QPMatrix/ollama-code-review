generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String        @id @default(uuid()) @db.Uuid
  githubId          String        @unique @map("github_id")
  githubUsername    String        @unique @map("github_username")
  githubAccessToken String        @map("github_access_token")
  avatarUrl         String?       @map("avatar_url")
  email             String?       @unique
  repositories      Repository[]
  createdAt         DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime      @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@map("users")
}

model Repository {
  id            String        @id @default(uuid()) @db.Uuid
  userId        String        @map("user_id") @db.Uuid
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  githubRepoId  String        @map("github_repo_id")
  fullName      String        @map("full_name")
  description   String?
  defaultBranch String        @map("default_branch")
  webhookId     String?       @map("webhook_id")
  webhookSecret String?       @map("webhook_secret")
  isActive      Boolean       @default(false) @map("is_active")
  ollamaModel   String        @map("ollama_model")
  pullRequests  PullRequest[]
  createdAt     DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime      @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@map("repositories")
  @@index([userId])
}

model PullRequest {
  id             String          @id @default(uuid()) @db.Uuid
  repositoryId   String          @map("repository_id") @db.Uuid
  repository     Repository      @relation(fields: [repositoryId], references: [id], onDelete: Cascade)
  githubPrId     String          @map("github_pr_id")
  title          String
  description    String?
  author         String
  baseBranch     String          @map("base_branch")
  headBranch     String          @map("head_branch")
  status         String
  reviewStatus   String          @map("review_status")
  reviewComments ReviewComment[]
  createdAt      DateTime        @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime        @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@map("pull_requests")
  @@index([repositoryId])
}

model ReviewComment {
  id              String      @id @default(uuid()) @db.Uuid
  pullRequestId   String      @map("pull_request_id") @db.Uuid
  pullRequest     PullRequest @relation(fields: [pullRequestId], references: [id], onDelete: Cascade)
  filePath        String      @map("file_path")
  lineNumber      Int?        @map("line_number")
  commentBody     String      @map("comment_body")
  severity        String
  category        String
  postedToGithub  Boolean     @default(false) @map("posted_to_github")
  githubCommentId String?     @map("github_comment_id")
  createdAt       DateTime    @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime    @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@map("review_comments")
  @@index([pullRequestId])
}
